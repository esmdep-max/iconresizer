// script_v126.js â€” stable version with iOS squircle masking for Square & iOS icons
document.addEventListener("DOMContentLoaded", () => {
  const dropArea = document.getElementById("drop-area");
  const fileInput = document.getElementById("file-input");
  const dropText = document.getElementById("drop-text");
  const generateBtn = document.getElementById("generate-btn");
  const squarePreview = document.getElementById("square-preview");
  const circlePreview = document.getElementById("circle-preview");

  let originalImage = null;
  const iosMaskBase64 = "data:image/png;base64,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AgAAAAAECAAAAAAQ8DEAvF/2KgAAAICjvG+bGwAAAACQIAAAAABAgAAAAAAAAQIAAAAABAgAAAAAECAAAAAAQIAAAAAAAAECAAAAAAQIAAAAABAgAAAAAECAAAAAAAABAgAAAAAECAAAAAAQIAAAAABAgAAAAAAAAQIAAAAABAgAAAAAECAAAAAAQIAAAAAAAAECAAAAAAQIAAAAABAgAAAAAECAAAAAAAABAgAAAAAECAAAAAAQIAAAAABAgAAAAAAAAQIAAAAABAgAAAAAEPD268/3S18FAAAAcCg3AAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIOCfbdver34RAAAAwLH+2bbt7eoXAQAAABzLRwAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAAAAAIEAAAAAAgQAAAAACAAAEAAAAAAgQAAAAACBAAAAAAIEAAAAAAgAABAAAAAAIEAAAAAAgQAAAAACBAAAAAAIAAAQAAAAACBAAA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";

  // Upload handlers
  dropArea.addEventListener("click", () => fileInput.click());
  dropArea.addEventListener("dragover", (e) => { e.preventDefault(); dropArea.classList.add("dragover"); });
  dropArea.addEventListener("dragleave", () => dropArea.classList.remove("dragover"));
  dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropArea.classList.remove("dragover");
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    handleFile(file);
  });
  fileInput.addEventListener("change", (e) => handleFile(e.target.files && e.target.files[0]));

  function handleFile(file) {
    if (!file) return;
    dropText.textContent = `Uploaded: ${file.name}`;
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        originalImage = img;
        drawPreview(img);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  function drawPreview(img) {
    const sCtx = squarePreview.getContext("2d");
    sCtx.clearRect(0, 0, squarePreview.width, squarePreview.height);
    sCtx.drawImage(img, 0, 0, squarePreview.width, squarePreview.height);

    const cCtx = circlePreview.getContext("2d");
    cCtx.clearRect(0, 0, circlePreview.width, circlePreview.height);
    cCtx.save();
    cCtx.beginPath();
    cCtx.arc(circlePreview.width / 2, circlePreview.height / 2, circlePreview.width / 2, 0, Math.PI * 2);
    cCtx.closePath();
    cCtx.clip();
    cCtx.drawImage(img, 0, 0, circlePreview.width, circlePreview.height);
    cCtx.restore();
  }

  async function resizeImage(img, w, h) {
    await img.decode?.();
    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, w, h);
    ctx.drawImage(img, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  async function applyMask(baseImg, w, h) {
    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    const mask = new Image();
    mask.src = iosMaskBase64;
    await Promise.all([baseImg.decode?.(), mask.decode?.()]);
    ctx.drawImage(baseImg, 0, 0, w, h);
    ctx.globalCompositeOperation = "destination-in";
    ctx.drawImage(mask, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  generateBtn.addEventListener("click", async () => {
    if (!originalImage) return;
    const zip = new JSZip();
    const allSizes = [16,24,32,36,57,64,96,114,128,144,192,256,512,1024,2048];

    const squareFolder = zip.folder("square");
    const circularFolder = zip.folder("circular");
    const iosFolder = zip.folder("iOS");
    const androidFolder = zip.folder("Android");
    const unmaskedFolder = zip.folder("Unmasked");

    for (const size of allSizes) {
      // Square (iOS mask)
      const resized = await resizeImage(originalImage, size, size);
      const img = new Image();
      img.src = resized;
      const masked = await applyMask(img, size, size);
      squareFolder.file(`icon-square-${size}x${size}.png`, masked.split(",")[1], { base64: true });

      // Circular
      const circCanvas = document.createElement("canvas");
      circCanvas.width = size;
      circCanvas.height = size;
      const ctx = circCanvas.getContext("2d");
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(originalImage, 0, 0, size, size);
      circularFolder.file(`icon-circular-${size}x${size}.png`, circCanvas.toDataURL("image/png").split(",")[1], { base64: true });

      // Unmasked
      unmaskedFolder.file(`icon-unmasked-${size}x${size}.png`, resized.split(",")[1], { base64: true });
    }

    // iOS icons (iOS mask)
    const iosSizes = [60,120,180,76,167,1024];
    for (const size of iosSizes) {
      const resized = await resizeImage(originalImage, size, size);
      const img = new Image();
      img.src = resized;
      const masked = await applyMask(img, size, size);
      iosFolder.file(`icon-ios-${size}x${size}.png`, masked.split(",")[1], { base64: true });
    }

    // Android (no mask)
    const androidSizes = [48,72,96,144,192,512];
    for (const size of androidSizes) {
      const resized = await resizeImage(originalImage, size, size);
      androidFolder.file(`icon-android-${size}x${size}.png`, resized.split(",")[1], { base64: true });
    }

    const content = await zip.generateAsync({ type: "blob" });
    saveAs(content, "icons.zip");
  });
});
